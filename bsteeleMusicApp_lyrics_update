#!/bin/bash 

#	asure we are in the correct place
appRoot=~/GitHub/bsteeleMusicApp
cd $appRoot

echo
date
pwd

src=gs://songlyrics.bsteele.com
dst=songlyrics
json=$appRoot/src/main/java/com/bsteele/bsteeleMusicApp/client/resources/allSongs.songlyrics

#	copy the google store images to local
mkdir -p $dst
#	note: without the -r option, gsutil rsync will not recurse into sub-directories, e.g. wars
gsutil -m rsync -p -d $src/ $dst

cd $dst

rm -f $json
firstJson=1
conversions=0

IFS=$(echo -en "\n\b")
for f in *.songlyrics
do
	echo $f
	c=`head -1 "$f" `
	if [ ${c:0:1} == '<' ]; then
		#	convert an old style file to new
		lyricsToJson -i "$f"
		echo "	conversion"
		conversions=1
	fi

	if [ "$firstJson" -eq 1 ]; then
		firstJson=0
		#echo "let newSongs = [" > $json
		echo "[" > $json
	else
		echo "," >> $json
	fi

	cat "$f" >> $json

done
echo "]" >> $json

if [ "$conversions" -eq 1 ]; then
	#	put any modified files back to source
	cd $appRoot
	gsutil -m rsync -p $dst/ $src
fi

exit $status
